<% form_for(@route) do |f| %>
  <%= f.error_messages %>

  <script type="text/javascript" src="http://www.google.com/jsapi?key=ABQIAAAAZBe7uHI90ESk2XAmWRL3RxR6u04U0tImA3bfwZ3-HKdEno7z2xRk2YE6OkudtBX5qy0vLrgbf1DUCg"></script>
  <script type="text/javascript">
    google.load("jquery", '1.3');
    google.load("maps", "2.x");
  </script>
  <html>
    <% @count = 0 %>
    <% @addresses.each do |address| %>
      <input id="name<%=h @count%>" type="hidden" value="<%=h address.firstname %> <%=h address.lastname %>" />
      <input id="date<%=h @count%>" type="hidden" value="<%=h address.created_at.year %>-<%=h address.created_at.month %>-<%=h address.created_at.day %>" />
      <input id="orderId<%=h @count%>" type="hidden" value="<%=h address.id %>" />
      <input id="longitude<%=h @count%>" type="hidden" value="<%=h address.longitude %>" />
      <input id="latitude<%=h @count%>" type="hidden" value="<%=h address.latitude %>" />
      <% @count = @count + 1 %>
    <% end %>
    <input id="count" type="hidden" value="<%=h @count%>" />
  </html>

  <script type="text/javascript" charset="utf-8">
    $(document).ready(function(){
      var map = new GMap2($("#map").get(0));
      map.enableScrollWheelZoom();
      var venezuelan = new GLatLng(10.463536424076864, -66.97718103149418);
      map.setCenter(venezuelan, 10);

      var markers = [];
      var count = document.getElementById("count").value;
      for (var i = 0; i < count; i++) {

        var longitude = document.getElementById("longitude"+i).value;
        var latitude = document.getElementById("latitude"+i).value;
        var name = document.getElementById("name"+i).value;

        var point = new GLatLng(latitude,longitude);
        marker = new GMarker(point);
        marker.title = name;
        marker.icon = "/images/car.png";
        map.addOverlay(marker);
        markers[i] = marker;
      }
      $(markers).each(function(i,marker){
        $("<li />")
        .html("<input type='checkbox' name='order_id[]' id='order_id[]' value="+document.getElementById("orderId"+i).value+"> #"+document.getElementById("orderId"+i).value+" "+document.getElementById("date"+i).value+" "+document.getElementById("name"+i).value)
        .click(function(){
          displayPoint(marker, i);
        })
        .appendTo("#list");

        GEvent.addListener(marker, "click", function(){
          displayPoint(marker, i);
        });
      });

      $("#message").appendTo(map.getPane(G_MAP_FLOAT_SHADOW_PANE));

      function displayPoint(marker, index){


        $("#message").hide();

        var moveEnd = GEvent.addListener(map, "moveend", function(){
          var markerOffset = map.fromLatLngToDivPixel(marker.getLatLng());
          $("#message")
          .fadeIn()
          .css({ top:markerOffset.y, left:markerOffset.x });

          GEvent.removeListener(moveEnd);
        });
        map.panTo(marker.getLatLng());
      }
    });
  </script>

  <style type="text/css" media="screen">
    #map { float:right; width:350px; height:250px; }
    #messages { position:absolute; padding:10px; background:#555; color:#fff; width:75px; }
    #list { float:left; width:200px; background:#FFF; list-style:none; padding:0; }
    #list li { padding:1px; }
    #list li:hover { background:#06c; color:#fff; cursor:pointer;}
  </style>

  <h1>New route</h1>
  <ul id="list">
    <table class="sample">
      <tr>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>#</td>
        <td>&nbsp;</td>
        <td>Date</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>Client</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
      </tr>
    </table>
  </ul>
  <div id="map"></div>
  <div id="message" class="messages" style="display:none;">
  </div>
  <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
  <p>
    <%= f.submit 'Create' %>
  </p>
<% end %>

<%= link_to 'Back', routes_path %>